var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.arrayIteratorImpl=function(a){var b=0;return function(){return b<a.length?{done:!1,value:a[b++]}:{done:!0}}};$jscomp.arrayIterator=function(a){return{next:$jscomp.arrayIteratorImpl(a)}};$jscomp.makeIterator=function(a){var b="undefined"!=typeof Symbol&&Symbol.iterator&&a[Symbol.iterator];return b?b.call(a):$jscomp.arrayIterator(a)};
var DBGLEVEL=1,COLLISION_MARGIN=4,RAY_MARGIN=580,CAST_MAX_DEPTH=3,BLOCK_SIZE=20,TEXTURE_SIZE=512,NEAR_MARGIN=400,INTERACT_MARGIN=300,MOVE_FWD_SPEED=2.5,MOVE_REV_SPEED=-2.5,TURN_SPEED=Math.PI/60,NUM_RAYS=500,DEV_MODE=!1,OFFSET_INTERACT_SAMPLES=20,CULL_NEAR_MARGIN=150,CULL_FAR_MARGIN=-9E3,CULL_SIDE_MARGIN=600,IN_FRONT_MARGIN=0,camera,map,mapData=[],attributes=[],textures=[],samples=[],interacts=[void 0,interact_Door,interact_Panel,interact_Secret,interact_Item,interact_End,interact_Audio],keys=[],keysRepeat=
[],gameTime="00:00:00",gameStarted=!1,gameCompleted=!1,framesRender=0,frameTime=0,inMobile=navigator.userAgent.match(/Android/i),width=2*NUM_RAYS+30,height=600,ctx,floorGradient,ceilingGradient;function DBG(a,b){(b&&b<=DBGLEVEL||3==DBGLEVEL)&&console.log(a)}function project(a){return{x:width-450+a.x/1.5,y:50+a.y/1.5}}function projectToLine(a,b){var d=Math.sqrt(b),c=10+a,e=8E3/d;d=255-Math.round(d);0>d&&(d=0);return{p0:{x:2*c,y:300-e},p1:{x:2*c,y:300+e},alpha:d/255}}
var GameMap=function(a,b){DBG("GameMap()",1);this.blockSize=BLOCK_SIZE;this.data=a;this.init(b)};GameMap.prototype.parseAttr=function(a){return{texture:a&255,target:a>>8&4095,interact:interacts[a>>20&15],params:a>>24&15,lock:DEV_MODE?0:a>>28&15}};
GameMap.prototype.init=function(a){var b=0;this.blocks=[];for(var d=0,c=$jscomp.makeIterator(this.data),e=c.next();!e.done;e=c.next()){var f=0;e=$jscomp.makeIterator(e.value);for(var h=e.next();!h.done;h=e.next()){h=h.value;if(" "!=h){var g={block:{type:h,index:d,attr:this.parseAttr(attributes[d])},center:{x:f+this.blockSize/2,y:b-this.blockSize/2}};switch(h){case "S":a.move(g.center.x,g.center.y);g=void 0;break;case "|":g.l1={x:f+this.blockSize/2};g.l2={x:f+this.blockSize/2};g.l3={y:b,ray:0};g.l4=
{y:b-this.blockSize,ray:0};break;case "-":g.l1={x:f,ray:0};g.l2={x:f+this.blockSize,ray:0};g.l3={y:b-this.blockSize/2};g.l4={y:b-this.blockSize/2};break;case "H":g.l1={x:f,ray:0};g.l2={x:f+this.blockSize,ray:0};g.l3={y:b};g.l4={y:b-this.blockSize};break;case "V":g.l1={x:f};g.l2={x:f+this.blockSize};g.l3={y:b,ray:0};g.l4={y:b-this.blockSize,ray:0};break;default:g.l1={x:f},g.l2={x:f+this.blockSize},g.l3={y:b},g.l4={y:b-this.blockSize}}g&&this.blocks.push(g)}f+=this.blockSize;d++}b+=this.blockSize}};
GameMap.prototype.inBlock=function(a,b){for(var d=$jscomp.makeIterator(this.nearest),c=d.next();!c.done;c=d.next())if(c=c.value,!textures[c.block.attr.texture].pass&&a>=c.l1.x-COLLISION_MARGIN&&a<=c.l2.x+COLLISION_MARGIN&&b<=c.l3.y+COLLISION_MARGIN&&b>=c.l4.y-COLLISION_MARGIN)return!0};
GameMap.prototype.intersect=function(a,b){for(var d=[],c=$jscomp.makeIterator(this.visible),e=c.next();!e.done;e=c.next())if(e=e.value,Math.abs(a.value(e.center))<RAY_MARGIN){var f=a.intersectSquare(e);if(camera.inFront(f)&&(f.block=e.block,d.unshift(f),d.length>=b))break}return d};GameMap.prototype.findBlock=function(a){for(var b=$jscomp.makeIterator(this.blocks),d=b.next();!d.done;d=b.next())if(d=d.value,d.block.index==a)return d};
GameMap.prototype.gotoBlock=function(a){a=this.findBlock(a);camera.move(a.center.x-BLOCK_SIZE,a.center.y)};GameMap.prototype.doCull=function(a){var b=[];this.nearest=[];for(var d=$jscomp.makeIterator(this.blocks),c=d.next();!c.done;c=d.next())c=c.value,c.distance=Math.pow(c.center.x-a.po.x,2)+Math.pow(c.center.y-a.po.y,2),c.distance<NEAR_MARGIN&&this.nearest.push(c),a.cull(c)&&b.push(c);return b};GameMap.prototype.sortBlocks=function(a){a.sort(function(a,d){return a.distance-d.distance})};
GameMap.prototype.drawLine=function(a,b,d){ctx.strokeStyle=0==d?"#444444":"#ffffff";ctx.beginPath();ctx.moveTo(a.x,a.y);ctx.lineTo(b.x,b.y);ctx.stroke()};
GameMap.prototype.drawBlocks=function(a){var b=$jscomp.makeIterator(this.blocks);for(a=b.next();!a.done;a=b.next()){a=a.value;var d=project({x:a.l1.x,y:a.l3.y}),c=project({x:a.l2.x,y:a.l3.y}),e=project({x:a.l2.x,y:a.l4.y}),f=project({x:a.l1.x,y:a.l4.y});this.drawLine(d,c,a.l3.ray);this.drawLine(c,e,a.l2.ray);this.drawLine(e,f,a.l4.ray);this.drawLine(f,d,a.l1.ray)}};
GameMap.prototype.draw=function(a,b,d){this.visible=this.doCull(a);this.sortBlocks(this.visible);b&&(this.drawBlocks(),a.draw());if(d){a.initRays();for(b=a.getRay();b;){d=this.intersect(b,CAST_MAX_DEPTH);d=$jscomp.makeIterator(d);for(var c=d.next();!c.done;c=d.next()){var e=c.value;c=projectToLine(b.rayIndex,e.d);var f=e.x-e.cx,h=e.y-e.cy;f=Math.floor(TEXTURE_SIZE/BLOCK_SIZE*Math.sqrt(f*f+h*h));e=textures[e.block.attr.texture];e.mask&&(ctx.globalAlpha=1,ctx.drawImage(e.mask,f,0,1,TEXTURE_SIZE,c.p0.x,
c.p0.y,2,c.p1.y-c.p0.y));ctx.globalAlpha=c.alpha;ctx.drawImage(e.tx,f,0,1,TEXTURE_SIZE,c.p0.x,c.p0.y,2,c.p1.y-c.p0.y)}b=a.getRay()}ctx.globalAlpha=1}};var Camera=function(){DBG("Camera()",1);this.numRays=NUM_RAYS;this.width=Math.PI/6;this.pdist=40;this.angle=0;this.pl={};this.pr={};this.po={};this.yPos=this.xPos=0;this.rotate(0)};Camera.prototype.move=function(a,b){this.xPos=a;this.yPos=b};
Camera.prototype.rotate=function(a){this.angle=a;this.pl={x:this.pdist*Math.cos(a-this.width),y:this.pdist*Math.sin(a-this.width)};this.pr={x:this.pdist*Math.cos(a+this.width),y:this.pdist*Math.sin(a+this.width)};this.po={x:this.xPos,y:this.yPos};this.pf={x:this.pdist*Math.cos(a+Math.PI/2),y:this.pdist*Math.sin(a+Math.PI/2)};this.pc={x:this.pdist*Math.cos(a),y:this.pdist*Math.sin(a)};this.pl.x+=this.xPos;this.pl.y+=this.yPos;this.pr.x+=this.xPos;this.pr.y+=this.yPos;this.pf.x+=this.xPos;this.pf.y+=
this.yPos;this.pc.x+=this.xPos;this.pc.y+=this.yPos;this.makeCullLines()};Camera.prototype.makeCullLines=function(){this.leftCull=new Line(this.po,this.pl);this.rightCull=new Line(this.po,this.pr);this.frontCull=new Line(this.po,this.pf)};Camera.prototype.cull=function(a){if(this.frontCull.value(a.center)<=CULL_NEAR_MARGIN&&this.frontCull.value(a.center)>=CULL_FAR_MARGIN&&this.leftCull.value(a.center)>-CULL_SIDE_MARGIN)return this.rightCull.value(a.center)<CULL_SIDE_MARGIN};
Camera.prototype.inFront=function(a){if(a&&this.frontCull.value(a)<=IN_FRONT_MARGIN)return!0};Camera.prototype.initRays=function(){this.ray={x:this.pl.x,y:this.pl.y};this.xadd=(this.pr.x-this.pl.x)/this.numRays;this.yadd=(this.pr.y-this.pl.y)/this.numRays;this.rayIndex=0};Camera.prototype.getCenterRay=function(){return new Line(this.po,this.pc)};
Camera.prototype.getRay=function(){if(this.rayIndex<this.numRays){var a=new Line(this.po,this.ray);a.rayIndex=this.rayIndex;this.ray.x+=this.xadd;this.ray.y+=this.yadd;this.rayIndex++;return a}};Camera.prototype.draw=function(){var a=project(this.pl),b=project(this.pr),d=project(this.po);ctx.beginPath();ctx.moveTo(a.x,a.y);ctx.lineTo(b.x,b.y);ctx.lineTo(d.x,d.y);ctx.lineTo(a.x,a.y);ctx.stroke()};var Line=function(a,b){this.p0=a;this.p1=b;this.A=a.y-b.y;this.B=b.x-a.x;this.C=a.x*b.y-b.x*a.y};
Line.prototype.value=function(a){return this.A*a.x+this.B*a.y+this.C};Line.prototype.intersectX=function(a){if(this.B)return{x:a,y:(-this.A*a-this.C)/this.B}};Line.prototype.intersectY=function(a){if(this.A)return{x:(-this.B*a-this.C)/this.A,y:a}};Line.prototype.intersect=function(a,b,d,c){if(0!=a.ray){var e;void 0!=a.x&&(e=this.intersectX(a.x));void 0!=a.y&&(e=this.intersectY(a.y));e&&(e.cx=d,e.cy=c,b.push(e))}};
Line.prototype.intersectSquare=function(a){var b=[];this.intersect(a.l1,b,a.l1.x,a.l3.y);this.intersect(a.l2,b,a.l2.x,a.l3.y);this.intersect(a.l3,b,a.l1.x,a.l3.y);this.intersect(a.l4,b,a.l1.x,a.l4.y);var d=[];b=$jscomp.makeIterator(b);for(var c=b.next();!c.done;c=b.next())c=c.value,c.x>=a.l1.x&&c.x<=a.l2.x&&c.y<=a.l3.y&&c.y>=a.l4.y&&(c.d=Math.pow(c.x-this.p0.x,2)+Math.pow(c.y-this.p0.y,2),d.push(c));d.sort(function(a,b){return a.d-b.d});return d[0]};
function interact_Door(a){DBG("Door access",2);a=a.block.attr;0==a.lock?(a.texture=textures[a.texture].alt,playSample(2)):(playSample(4),addMessage("Ovi on lukossa"))}
function interact_Panel(a){DBG("Panel access",2);var b=parseInt(prompt("Enter code"));playSample(3,function(){var d=a.block.attr,c=d.texture,e=textures[c],f=(a.block.index%100).toString(),h=map.findBlock(d.target).block.attr;b==f&&c!=e.alt?(d.texture=e.alt,h.lock--):b!=f&&c!=e["default"]&&(d.texture=e["default"],h.lock++);addMessage(b==f?"Oikea koodi":"V‰‰r‰ koodi");keys[4]=!1;keysRepeat[4]=!1;DBG("Lock: "+h.lock,2)})}
function interact_Secret(a){DBG("Secret access",2);var b=a.block.attr;if(0!=b.lock||b.moving)playSample(4);else{playSample(5);b.moving=!0;var d=0,c=map.findBlock(a.block.index),e=setInterval(function(){c.l3.y++;c.l4.y++;c.center.y++;d++;40<=d&&clearInterval(e)},50);addMessage("Salak‰yt‰v‰!")}}
function interact_Item(a){DBG("Item access",2);map.findBlock(a.block.attr.target).block.attr.lock=0;a=map.findBlock(a.block.index);a.l1.ray=0;a.l2.ray=0;a.l3.ray=0;a.l4.ray=0;playSample(6);addMessage("Avain vapauteen!")}function interact_End(a){DBG("End access",2);a=a.block.attr;0==a.lock&&(gameCompleted=!0,a.texture=textures[a.texture].alt,a.lock=-1,playSample(7),addMessage("Selvisit ulos!"));0<a.lock&&playSample(4)}
function interact_Audio(a){DBG("Audio access",2);playSample(a.block.attr.params+OFFSET_INTERACT_SAMPLES)}function moveCamera(a,b){var d=camera.xPos+Math.cos(b)*a,c=camera.yPos+Math.sin(b)*a;map.inBlock(d,c)?map.inBlock(d,camera.yPos)?map.inBlock(camera.xPos,c)||(camera.yPos=c):camera.xPos=d:(camera.xPos=d,camera.yPos=c)}function playSample(a,b){var d=samples[a],c=d.snd;d.volume&&(c.volume=d.volume);d.loop&&(c.loop=!0);c.onended=b;c.currentTime=0;c.play()}
function addMessage(a){var b=document.getElementById("row_1"),d=document.getElementById("row_2"),c=document.getElementById("row_3"),e=document.getElementById("row_4");b.innerHTML=d.innerHTML;d.innerHTML=c.innerHTML;c.innerHTML=e.innerHTML;e.innerHTML=a}
function getLevel(){mapData=level1.blocks;attributes=level1.attributes;if(localStorage.getItem("map_editor")){var a=localStorage.getItem("map_data");if(null!=a){var b=parseInt(localStorage.getItem("map_w")),d=parseInt(localStorage.getItem("map_h")),c=0;mapData=[];for(var e=0;e<d;e++){var f=a.substr(c,b);mapData.push(f);c+=b}}a=localStorage.getItem("map_attributes");null!=a&&(attributes=[],a.split(",").forEach(function(a){attributes.push(parseInt(a))}))}}
function draw(a,b){ctx.clearRect(0,0,width,height);ctx.strokeStyle="#ffffff";b&&(ctx.fillStyle=ceilingGradient,ctx.fillRect(20,0,1E3,300),ctx.fillStyle=floorGradient,ctx.fillRect(20,320,1E3,height-300));map.draw(camera,a,b)}
function registerMouseEvents(a){var b=document.getElementById("ctrl_"+a);inMobile?(b.addEventListener("touchstart",function(){onControls(a,!0)}),b.addEventListener("touchend",function(){onControls(a,!1)}),b.addEventListener("touchcancel",function(){onControls(a,!1)})):(b.onmousedown=function(b){onControls(a,!0)},b.onmouseup=function(b){onControls(a,!1)},b.onmouseover=function(b){onControls(a,1==b.buttons)},b.onmouseleave=function(b){onControls(a,!1)})}
function onControls(a,b){b?(beginGame(),keys[a]=!0):(keys[a]=!1,keysRepeat[4]=!1)}function beginGame(){gameStarted||(playSample(1),gameStarted=!0,gameCompleted=!1,gameTime=new Date,frameTime=new Date)}function getTimeStr(a){a=Math.round(a/1E3);var b=a%60,d=Math.floor(a/60)%60;a=Math.floor(a/3600);return b=(10>a?"0":"")+a+":"+((10>d?"0":"")+d+":")+((10>b?"0":"")+b)}
function gameInit(){DBG("Params: "+document.location.hash,1);var a=document.location.hash.substr(1).split(":"),b;for(b in a)eval(a[b]);a=document.getElementById("myCanvas");a.width=width;a.height=height;ctx=a.getContext("2d");ceilingGradient=ctx.createLinearGradient(0,0,0,300);ceilingGradient.addColorStop(0,"blue");ceilingGradient.addColorStop(.9,"black");floorGradient=ctx.createLinearGradient(0,300,0,height);floorGradient.addColorStop(.1,"black");floorGradient.addColorStop(1,"white");camera=new Camera;
getLevel();map=new GameMap(mapData,camera);var d=0;setInterval(function(){draw(!1,!0);framesRender++},30);setInterval(function(){keys[0]&&(d-=TURN_SPEED);keys[1]&&(d+=TURN_SPEED);keys[2]&&moveCamera(MOVE_FWD_SPEED,d);keys[3]&&moveCamera(MOVE_REV_SPEED,d);if(keys[4]&&!keysRepeat[4]){var a=map.intersect(camera.getCenterRay(),1)[0];a&&a.d<=INTERACT_MARGIN&&a.block.attr.interact&&a.block.attr.interact(a);keysRepeat[4]=!0}for(a=0;5>a;a++){var b=keys[a];document.getElementById("ctrl_"+a).className=b?"hl-input":
""}camera.rotate(d)},35);setInterval(function(){if(gameStarted&&!gameCompleted){var a=new Date,b=new Date(a-gameTime);document.getElementById("game_time").innerHTML=getTimeStr(b);DBG("Frames rendered: "+framesRender+", time(ms):"+((a-frameTime)/framesRender).toFixed(1),2);framesRender=0;frameTime=a}},500);document.addEventListener("keydown",function(a){beginGame();switch(a.key){case "ArrowLeft":case "a":keys[0]=!0;break;case "ArrowRight":case "d":keys[1]=!0;break;case "ArrowUp":case "w":keys[2]=!0;
break;case "ArrowDown":case "s":keys[3]=!0;break;case " ":case "e":keys[4]=!0}});document.addEventListener("keyup",function(a){switch(a.key){case "ArrowLeft":case "a":keys[0]=!1;break;case "ArrowRight":case "d":keys[1]=!1;break;case "ArrowUp":case "w":keys[2]=!1;break;case "ArrowDown":case "s":keys[3]=!1;break;case " ":case "e":keys[4]=!1,keysRepeat[4]=!1}});textures[1]={tx:document.getElementById("tx_wall"),mask:document.getElementById("tx_wall_mask")};textures[2]={tx:document.getElementById("tx_ournament"),
mask:document.getElementById("tx_wall_mask")};textures[3]={tx:document.getElementById("tx_door_open"),mask:document.getElementById("tx_door_open_mask"),alt:4,pass:!0};textures[4]={tx:document.getElementById("tx_door"),mask:document.getElementById("tx_wall_mask"),alt:3};textures[5]={tx:document.getElementById("tx_door_red"),mask:document.getElementById("tx_wall_mask"),alt:6};textures[6]={tx:document.getElementById("tx_door_open"),mask:document.getElementById("tx_door_open_mask"),alt:5,pass:!0};textures[7]=
{tx:document.getElementById("tx_code_ok"),mask:document.getElementById("tx_wall_mask"),alt:7,"default":8};textures[8]={tx:document.getElementById("tx_code_fail"),mask:document.getElementById("tx_wall_mask"),alt:7,"default":8};textures[9]={tx:document.getElementById("tx_avain"),mask:document.getElementById("tx_avain_mask"),pass:!0};textures[10]={tx:document.getElementById("tx_tl3"),mask:document.getElementById("tx_wall_mask")};textures[11]={tx:document.getElementById("tx_pete"),mask:document.getElementById("tx_wall_mask")};
textures[12]={tx:document.getElementById("tx_humg"),mask:document.getElementById("tx_wall_mask")};textures[13]={tx:document.getElementById("tx_hudson"),mask:document.getElementById("tx_wall_mask")};textures[14]={tx:document.getElementById("tx_codes1"),mask:document.getElementById("tx_wall_mask")};textures[15]={tx:document.getElementById("tx_codes2"),mask:document.getElementById("tx_wall_mask")};textures[16]={tx:document.getElementById("tx_jussi"),mask:document.getElementById("tx_wall_mask")};textures[17]=
{tx:document.getElementById("tx_pomot"),mask:document.getElementById("tx_wall_mask")};textures[18]={tx:document.getElementById("tx_mka"),mask:document.getElementById("tx_wall_mask")};samples[1]={snd:document.getElementById("snd_wind"),volume:.1,loop:!0};samples[2]={snd:document.getElementById("snd_door"),volume:.7};samples[3]={snd:document.getElementById("snd_code"),volume:.7};samples[4]={snd:document.getElementById("snd_locked"),volume:.6};samples[5]={snd:document.getElementById("snd_secret"),volume:.6};
samples[6]={snd:document.getElementById("snd_item"),volume:.6};samples[7]={snd:document.getElementById("snd_end"),volume:.6};samples[20]={snd:document.getElementById("snd_0"),volume:.6};samples[21]={snd:document.getElementById("snd_1"),volume:.6};samples[22]={snd:document.getElementById("snd_2"),volume:.6};samples[23]={snd:document.getElementById("snd_3"),volume:.6};samples[24]={snd:document.getElementById("snd_4"),volume:.6};registerMouseEvents(0);registerMouseEvents(1);registerMouseEvents(2);registerMouseEvents(3);
registerMouseEvents(4);DBG("Init complete",1)};