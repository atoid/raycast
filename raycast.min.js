'use strict';var DBGLEVEL=1;const COLLISION_MARGIN=4,RAY_MARGIN=580,CAST_MAX_DEPTH=3,BLOCK_SIZE=20,TEXTURE_SIZE=512,NEAR_MARGIN=400,INTERACT_MARGIN=300,MOVE_FWD_SPEED=2.5,MOVE_REV_SPEED=-2.5,TURN_SPEED=Math.PI/60,NUM_RAYS=500,DEV_MODE=0,OFFSET_INTERACT_SAMPLES=20,CULL_NEAR_MARGIN=150,CULL_FAR_MARGIN=-9E3,CULL_SIDE_MARGIN=600,IN_FRONT_MARGIN=0;
var camera,map,mapData=[],attributes=[],textures=[],samples=[],interacts=[void 0,interact_Door,interact_Panel,interact_Secret,interact_Item,interact_End,interact_Audio],keys=[],keysRepeat=[],gameTime="00:00:00",gameStarted=!1,gameCompleted=!1,framesRender=0,frameTime=0,inMobile=navigator.userAgent.match(/Android/i),width=2*NUM_RAYS+30,height=600,ctx,floorGradient,ceilingGradient,lastFps=0;function DBG(a,b){(b&&b<=DBGLEVEL||3==DBGLEVEL)&&console.log(a)}
function project(a){return{x:width-450+a.x/1.5,y:50+a.y/1.5}}function projectToLine(a,b){b=Math.sqrt(b);a=10+a;var c=8E3/b;b=255-Math.round(b);0>b&&(b=0);return{p0:{x:2*a,y:300-c},p1:{x:2*a,y:300+c},alpha:b/255}}
class GameMap{constructor(a,b){DBG("GameMap()",1);this.blockSize=BLOCK_SIZE;this.data=a;this.init(b)}parseAttr(a){return{texture:a&255,target:a>>8&4095,interact:interacts[a>>20&15],params:a>>24&15,lock:DEV_MODE?0:a>>28&15}}init(a){var b=0;this.blocks=[];var c=0,e;for(e of this.data){var d=0,g;for(g of e){if(" "!=g){var f={block:{type:g,index:c,attr:this.parseAttr(attributes[c])},center:{x:d+this.blockSize/2,y:b-this.blockSize/2}};switch(g){case "S":a.move(f.center.x,f.center.y);f=void 0;break;case "|":f.l1=
{x:d+this.blockSize/2};f.l2={x:d+this.blockSize/2};f.l3={y:b,ray:0};f.l4={y:b-this.blockSize,ray:0};break;case "-":f.l1={x:d,ray:0};f.l2={x:d+this.blockSize,ray:0};f.l3={y:b-this.blockSize/2};f.l4={y:b-this.blockSize/2};break;case "H":f.l1={x:d,ray:0};f.l2={x:d+this.blockSize,ray:0};f.l3={y:b};f.l4={y:b-this.blockSize};break;case "V":f.l1={x:d};f.l2={x:d+this.blockSize};f.l3={y:b,ray:0};f.l4={y:b-this.blockSize,ray:0};break;default:f.l1={x:d},f.l2={x:d+this.blockSize},f.l3={y:b},f.l4={y:b-this.blockSize}}f&&
this.blocks.push(f)}d+=this.blockSize;c++}b+=this.blockSize}}inBlock(a,b){for(var c of this.nearest)if(!textures[c.block.attr.texture].pass&&a>=c.l1.x-COLLISION_MARGIN&&a<=c.l2.x+COLLISION_MARGIN&&b<=c.l3.y+COLLISION_MARGIN&&b>=c.l4.y-COLLISION_MARGIN)return!0}intersect(a,b){var c=[],e;for(e of this.visible)if(Math.abs(a.value(e.center))<RAY_MARGIN){var d=a.intersectSquare(e);if(camera.inFront(d)&&(d.block=e.block,c.unshift(d),c.length>=b))break}return c}findBlock(a){for(var b of this.blocks)if(b.block.index==
a)return b}gotoBlock(a){a=this.findBlock(a);camera.move(a.center.x-BLOCK_SIZE,a.center.y)}doCull(a){var b=[];this.nearest=[];for(var c of this.blocks)c.distance=Math.pow(c.center.x-a.po.x,2)+Math.pow(c.center.y-a.po.y,2),c.distance<NEAR_MARGIN&&this.nearest.push(c),a.cull(c)&&b.push(c);return b}sortBlocks(a){a.sort(function(a,c){return a.distance-c.distance})}draw(a){this.visible=this.doCull(a);this.sortBlocks(this.visible);a.initRays();for(var b=a.getRay();b;){var c=this.intersect(b,CAST_MAX_DEPTH),
e;for(e of c){c=projectToLine(b.rayIndex,e.d);var d=e.x-e.cx,g=e.y-e.cy;d=Math.floor(TEXTURE_SIZE/BLOCK_SIZE*Math.sqrt(d*d+g*g));g=textures[e.block.attr.texture];g.mask&&(ctx.globalAlpha=1,ctx.drawImage(g.mask,d,0,1,TEXTURE_SIZE,c.p0.x,c.p0.y,2,c.p1.y-c.p0.y));ctx.globalAlpha=c.alpha;ctx.drawImage(g.tx,d,0,1,TEXTURE_SIZE,c.p0.x,c.p0.y,2,c.p1.y-c.p0.y)}b=a.getRay()}ctx.globalAlpha=1}}
class Camera{constructor(){DBG("Camera()",1);this.numRays=NUM_RAYS;this.width=Math.PI/6;this.pdist=40;this.angle=0;this.pl={};this.pr={};this.po={};this.yPos=this.xPos=0;this.rotate(0)}move(a,b){this.xPos=a;this.yPos=b}rotate(a){this.angle=a;this.pl={x:this.pdist*Math.cos(a-this.width),y:this.pdist*Math.sin(a-this.width)};this.pr={x:this.pdist*Math.cos(a+this.width),y:this.pdist*Math.sin(a+this.width)};this.po={x:this.xPos,y:this.yPos};this.pf={x:this.pdist*Math.cos(a+Math.PI/2),y:this.pdist*Math.sin(a+
Math.PI/2)};this.pc={x:this.pdist*Math.cos(a),y:this.pdist*Math.sin(a)};this.pl.x+=this.xPos;this.pl.y+=this.yPos;this.pr.x+=this.xPos;this.pr.y+=this.yPos;this.pf.x+=this.xPos;this.pf.y+=this.yPos;this.pc.x+=this.xPos;this.pc.y+=this.yPos;this.makeCullLines()}makeCullLines(){this.leftCull=new Line(this.po,this.pl);this.rightCull=new Line(this.po,this.pr);this.frontCull=new Line(this.po,this.pf)}cull(a){if(this.frontCull.value(a.center)<=CULL_NEAR_MARGIN&&this.frontCull.value(a.center)>=CULL_FAR_MARGIN&&
this.leftCull.value(a.center)>-CULL_SIDE_MARGIN)return this.rightCull.value(a.center)<CULL_SIDE_MARGIN}inFront(a){if(a&&this.frontCull.value(a)<=IN_FRONT_MARGIN)return!0}initRays(){this.ray={x:this.pl.x,y:this.pl.y};this.xadd=(this.pr.x-this.pl.x)/this.numRays;this.yadd=(this.pr.y-this.pl.y)/this.numRays;this.rayIndex=0}getCenterRay(){return new Line(this.po,this.pc)}getRay(){if(this.rayIndex<this.numRays){var a=new Line(this.po,this.ray);a.rayIndex=this.rayIndex;this.ray.x+=this.xadd;this.ray.y+=
this.yadd;this.rayIndex++;return a}}}
class Line{constructor(a,b){this.p0=a;this.p1=b;this.A=a.y-b.y;this.B=b.x-a.x;this.C=a.x*b.y-b.x*a.y}value(a){return this.A*a.x+this.B*a.y+this.C}intersectX(a){if(this.B)return{x:a,y:(-this.A*a-this.C)/this.B}}intersectY(a){if(this.A)return{x:(-this.B*a-this.C)/this.A,y:a}}intersect(a,b,c,e){if(0!=a.ray){var d;void 0!=a.x&&(d=this.intersectX(a.x));void 0!=a.y&&(d=this.intersectY(a.y));d&&(d.cx=c,d.cy=e,b.push(d))}}intersectSquare(a){var b=[];this.intersect(a.l1,b,a.l1.x,a.l3.y);this.intersect(a.l2,
b,a.l2.x,a.l3.y);this.intersect(a.l3,b,a.l1.x,a.l3.y);this.intersect(a.l4,b,a.l1.x,a.l4.y);var c=[],e;for(e of b)e.x>=a.l1.x&&e.x<=a.l2.x&&e.y<=a.l3.y&&e.y>=a.l4.y&&(e.d=Math.pow(e.x-this.p0.x,2)+Math.pow(e.y-this.p0.y,2),c.push(e));c.sort(function(a,b){return a.d-b.d});return c[0]}}function interact_Door(a){DBG("Door access",2);a=a.block.attr;0==a.lock?(a.texture=textures[a.texture].alt,playSample(2)):(playSample(4),addMessage("Ovi on lukossa"))}
function interact_Panel(a){DBG("Panel access",2);var b=parseInt(prompt("Enter code"));playSample(3,function(){var c=a.block.attr,e=c.texture,d=textures[e],g=(a.block.index%100).toString(),f=map.findBlock(c.target).block.attr;b==g&&e!=d.alt?(c.texture=d.alt,f.lock--):b!=g&&e!=d.default&&(c.texture=d.default,f.lock++);addMessage(b==g?"Oikea koodi":"V&auml;&auml;r&auml; koodi");keys[4]=!1;keysRepeat[4]=!1;DBG("Lock: "+f.lock,2)})}
function interact_Secret(a){DBG("Secret access",2);var b=a.block.attr;if(0!=b.lock||b.moving)playSample(4);else{playSample(5);b.moving=!0;var c=0,e=map.findBlock(a.block.index),d=setInterval(function(){e.l3.y++;e.l4.y++;e.center.y++;c++;40<=c&&clearInterval(d)},50);addMessage("Salak&auml;yt&auml;v&auml;!")}}
function interact_Item(a){DBG("Item access",2);map.findBlock(a.block.attr.target).block.attr.lock=0;a=map.findBlock(a.block.index);a.l1.ray=0;a.l2.ray=0;a.l3.ray=0;a.l4.ray=0;playSample(6);addMessage("Avain vapauteen!")}function interact_End(a){DBG("End access",2);a=a.block.attr;0==a.lock&&(gameCompleted=!0,a.texture=textures[a.texture].alt,a.lock=-1,playSample(7),addMessage("Selvisit ulos!"));0<a.lock&&playSample(4)}
function interact_Audio(a){DBG("Audio access",2);playSample(a.block.attr.params+OFFSET_INTERACT_SAMPLES)}function moveCamera(a,b){var c=camera.xPos+Math.cos(b)*a;a=camera.yPos+Math.sin(b)*a;map.inBlock(c,a)?map.inBlock(c,camera.yPos)?map.inBlock(camera.xPos,a)||(camera.yPos=a):camera.xPos=c:(camera.xPos=c,camera.yPos=a)}function playSample(a,b){a=samples[a];var c=a.snd;a.volume&&(c.volume=a.volume);a.loop&&(c.loop=!0);c.onended=b;c.currentTime=0;c.play()}
function addMessage(a){var b=document.getElementById("row_1"),c=document.getElementById("row_2"),e=document.getElementById("row_3"),d=document.getElementById("row_4");b.innerHTML=c.innerHTML;c.innerHTML=e.innerHTML;e.innerHTML=d.innerHTML;d.innerHTML=a}
function getLevel(){mapData=level1.blocks;attributes=level1.attributes;if(localStorage.getItem("map_editor")){var a=localStorage.getItem("map_data");if(null!=a){var b=parseInt(localStorage.getItem("map_w")),c=parseInt(localStorage.getItem("map_h")),e=0;mapData=[];for(var d=0;d<c;d++){var g=a.substr(e,b);mapData.push(g);e+=b}}a=localStorage.getItem("map_attributes");null!=a&&(attributes=[],a.split(",").forEach(function(a){attributes.push(parseInt(a))}))}}
function draw(){ctx.clearRect(0,0,width,height);ctx.strokeStyle="#ffffff";ctx.fillStyle=ceilingGradient;ctx.fillRect(20,0,1E3,300);ctx.fillStyle=floorGradient;ctx.fillRect(20,320,1E3,height-300);map.draw(camera);ctx.fillStyle="#fff";ctx.fillText("FPS: "+lastFps,30,20)}
function registerMouseEvents(a){var b=document.getElementById("ctrl_"+a);inMobile?(b.addEventListener("touchstart",function(){onControls(a,!0)}),b.addEventListener("touchend",function(){onControls(a,!1)}),b.addEventListener("touchcancel",function(){onControls(a,!1)})):(b.onmousedown=function(b){onControls(a,!0)},b.onmouseup=function(b){onControls(a,!1)},b.onmouseover=function(b){onControls(a,1==b.buttons)},b.onmouseleave=function(b){onControls(a,!1)})}
function onControls(a,b){b?(beginGame(),keys[a]=!0):(keys[a]=!1,keysRepeat[4]=!1)}function beginGame(){gameStarted||(playSample(1),gameStarted=!0,gameCompleted=!1,gameTime=new Date,frameTime=new Date)}function getTimeStr(a){a=Math.round(a/1E3);var b=a%60,c=Math.floor(a/60)%60;a=Math.floor(a/3600);return b=(10>a?"0":"")+a+":"+((10>c?"0":"")+c+":")+((10>b?"0":"")+b)}
function gameInit(){DBG("Params: "+document.location.hash,1);var a=document.location.hash.substr(1).split(":"),b;for(b in a)eval(a[b]);a=document.getElementById("myCanvas");a.width=width;a.height=height;ctx=a.getContext("2d");ctx.font="16px Arial";ceilingGradient=ctx.createLinearGradient(0,0,0,300);ceilingGradient.addColorStop(0,"blue");ceilingGradient.addColorStop(.9,"black");floorGradient=ctx.createLinearGradient(0,300,0,height);floorGradient.addColorStop(.1,"black");floorGradient.addColorStop(1,
"white");camera=new Camera;getLevel();map=new GameMap(mapData,camera);var c=0;setInterval(function(){draw();framesRender++},30);setInterval(function(){keys[0]&&(c-=TURN_SPEED);keys[1]&&(c+=TURN_SPEED);keys[2]&&moveCamera(MOVE_FWD_SPEED,c);keys[3]&&moveCamera(MOVE_REV_SPEED,c);if(keys[4]&&!keysRepeat[4]){var a=map.intersect(camera.getCenterRay(),1)[0];a&&a.d<=INTERACT_MARGIN&&a.block.attr.interact&&a.block.attr.interact(a);keysRepeat[4]=!0}for(a=0;5>a;a++){var b=keys[a];document.getElementById("ctrl_"+
a).className=b?"hl-input":""}camera.rotate(c)},35);setInterval(function(){var a=new Date;if(gameStarted&&!gameCompleted){var b=new Date(a-gameTime);document.getElementById("game_time").innerHTML=getTimeStr(b)}DBG("Frames rendered: "+framesRender+", time(ms):"+((a-frameTime)/framesRender).toFixed(1),2);lastFps=2*framesRender;framesRender=0;frameTime=a},500);document.addEventListener("keydown",function(a){beginGame();switch(a.key){case "ArrowLeft":case "a":keys[0]=!0;break;case "ArrowRight":case "d":keys[1]=
!0;break;case "ArrowUp":case "w":keys[2]=!0;break;case "ArrowDown":case "s":keys[3]=!0;break;case " ":case "e":keys[4]=!0}});document.addEventListener("keyup",function(a){switch(a.key){case "ArrowLeft":case "a":keys[0]=!1;break;case "ArrowRight":case "d":keys[1]=!1;break;case "ArrowUp":case "w":keys[2]=!1;break;case "ArrowDown":case "s":keys[3]=!1;break;case " ":case "e":keys[4]=!1,keysRepeat[4]=!1}});textures[1]={tx:document.getElementById("tx_wall"),mask:document.getElementById("tx_wall_mask")};
textures[2]={tx:document.getElementById("tx_ournament"),mask:document.getElementById("tx_wall_mask")};textures[3]={tx:document.getElementById("tx_door_open"),mask:document.getElementById("tx_door_open_mask"),alt:4,pass:!0};textures[4]={tx:document.getElementById("tx_door"),mask:document.getElementById("tx_wall_mask"),alt:3};textures[5]={tx:document.getElementById("tx_door_red"),mask:document.getElementById("tx_wall_mask"),alt:6};textures[6]={tx:document.getElementById("tx_door_open"),mask:document.getElementById("tx_door_open_mask"),
alt:5,pass:!0};textures[7]={tx:document.getElementById("tx_code_ok"),mask:document.getElementById("tx_wall_mask"),alt:7,default:8};textures[8]={tx:document.getElementById("tx_code_fail"),mask:document.getElementById("tx_wall_mask"),alt:7,default:8};textures[9]={tx:document.getElementById("tx_avain"),mask:document.getElementById("tx_avain_mask"),pass:!0};textures[10]={tx:document.getElementById("tx_tl3"),mask:document.getElementById("tx_wall_mask")};textures[11]={tx:document.getElementById("tx_pete"),
mask:document.getElementById("tx_wall_mask")};textures[12]={tx:document.getElementById("tx_humg"),mask:document.getElementById("tx_wall_mask")};textures[13]={tx:document.getElementById("tx_hudson"),mask:document.getElementById("tx_wall_mask")};textures[14]={tx:document.getElementById("tx_codes1"),mask:document.getElementById("tx_wall_mask")};textures[15]={tx:document.getElementById("tx_codes2"),mask:document.getElementById("tx_wall_mask")};textures[16]={tx:document.getElementById("tx_jussi"),mask:document.getElementById("tx_wall_mask")};
textures[17]={tx:document.getElementById("tx_pomot"),mask:document.getElementById("tx_wall_mask")};textures[18]={tx:document.getElementById("tx_mka"),mask:document.getElementById("tx_wall_mask")};samples[1]={snd:document.getElementById("snd_wind"),volume:.1,loop:!0};samples[2]={snd:document.getElementById("snd_door"),volume:.7};samples[3]={snd:document.getElementById("snd_code"),volume:.7};samples[4]={snd:document.getElementById("snd_locked"),volume:.6};samples[5]={snd:document.getElementById("snd_secret"),
volume:.6};samples[6]={snd:document.getElementById("snd_item"),volume:.6};samples[7]={snd:document.getElementById("snd_end"),volume:.6};samples[20]={snd:document.getElementById("snd_0"),volume:.6};samples[21]={snd:document.getElementById("snd_1"),volume:.6};samples[22]={snd:document.getElementById("snd_2"),volume:.6};samples[23]={snd:document.getElementById("snd_3"),volume:.6};samples[24]={snd:document.getElementById("snd_4"),volume:.6};registerMouseEvents(0);registerMouseEvents(1);registerMouseEvents(2);
registerMouseEvents(3);registerMouseEvents(4);DBG("Init complete",1)};